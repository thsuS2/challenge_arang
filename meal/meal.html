<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹ë‹¨ê¸°ë¡</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css" />
<style>
/*ì±„íŒ…ë´‡ ìˆ¨ê¹€*/
.hide {display : none !important}
/*pcë¡œ ë³´ê¸° ìˆ¨ê¹€*/
.pc_mode_btn_wrap{ display: none !important;}
 
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  font-family: Pretendard;
}
.toggle-switch.active{background: #32A59C;}
.hide {
    display: none !important;
}

body {
    font-family: 'Pretendard', sans-serif;
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100vh;
    overflow: hidden;
}

.wrap {
    display: flex;
    flex-direction: column;
    width: 100%;
    height: 100vh;
    background: #ffffff;
    overflow: hidden;
}

/* í—¤ë” */
.header {
    flex-shrink: 0;
    height: 70px;
    background: #fff;
    border-bottom: 1px solid #e9eaec;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 28px;
}

.home-btn {
    width: 38px;
    height: 38px;
    background: none;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.progress-info {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-left: 20px;
}

.progress-text {
    font-family: 'Pretendard', sans-serif;
    font-weight: 500;
    font-size: 11px;
    color: #b4b4b4;
    min-width: 30px;
}

.progress-bar {
    width: 60vw;
    height: 16px;
    background: #f7f8f9;
    border-radius: 30px;
    overflow: hidden;
}

.progress-fill {
    width: 0%;
    height: 100%;
    background: #32a59c;
    border-radius: 30px;
    transition: width 0.3s ease;
}


/* ë©”ì¸ ì½˜í…ì¸  ì»¨í…Œì´ë„ˆ */
.main-content {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding-bottom: 30px;
}

/* ë©”ì¸ ì½˜í…ì¸  */
.meal-type-section {
    padding: 20px 30px 30px;
}

.meal-type-section h2 {
    font-family: 'Pretendard', sans-serif;
    font-weight: 700;
    font-size: 19px;
    color: #212121;
    letter-spacing: -0.5px;
    margin-bottom: 15px;
}

.required {
    font-family: 'Pretendard', sans-serif;
    font-weight: 500;
    font-size: 14px;
    color: #ed6060;
    letter-spacing: -0.28px;
}

.meal-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(1, 1fr);
    gap: 15px;
    width: 100%;
    height: 80px;
}

.meal-option {
    background: #e1e7e5;
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.2s;
}

.meal-option.selected {
    background: #32a59c;
}

.meal-option .meal-emoji {
    font-size: 19px;
    margin-bottom: 0px;
}

.meal-option span {
    font-family: 'Pretendard', sans-serif;
    font-weight: 500;
    font-size: 19px;
    color: #8b8b8b;
    letter-spacing: 0.5px;
}

.meal-option.selected span {
    color: #ffffff;
}

/* ì‹ì‚¬ ì •ë³´ ì„¹ì…˜ */
.meal-info-section {
    padding: 0 30px 30px;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.meal-info-section h2 {
    font-family: 'Pretendard', sans-serif;
    font-weight: 700;
    font-size: 19px;
    color: #212121;
    letter-spacing: -0.5px;
}

.fasting-toggle {
    display: flex;
    align-items: center;
    gap: 10px;
}

.fasting-toggle span {
    font-family: 'Pretendard', sans-serif;
    font-weight: 500;
    font-size: 19px;
    color: #999999;
    letter-spacing: -0.38px;
}

.toggle-switch {
    position: relative;
    width: 31px;
    height: 18px;
    background: #e1e7e5;
    border-radius: 53px;
    cursor: pointer;
}

.toggle-slider {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 14px;
    height: 14px;
    background: #ffffff;
    border-radius: 50%;
    transition: transform 0.2s;
}

.toggle-switch.active .toggle-slider {
    transform: translateX(13px);
}

.meal-input {
    display: flex;
    gap: 15px;
    margin-bottom: 10px;
}

.meal-input input {
    flex: 1;
    height: 45px;
    width: 100%;
    border: 1px solid #a8a8a8;
    border-radius: 8px;
    padding: 0 13px;
    font-family: 'Pretendard', sans-serif;
    font-weight: 500;
    font-size: 14px;
    letter-spacing: -0.28px;
}

input.error {
    color: #ed6060 !important;
    border-color: #ed6060 !important;
}

.meal-input input::placeholder {
    color: #a5a5a5;
}

.photo-upload {
    width: 69px;
    height: 45px;
}

.upload-area {
    width: 100%;
    height: 60px;
    background: #f7f8f9;
    border: 1px dashed #d1d5db;
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: border-color 0.2s;
}

.upload-area:hover {
    border-color: #32a59c;
}

.upload-icon {
    font-size: 24px;
    color: #9ca3af;
    margin-bottom: 8px;
}

.upload-text {
    font-family: 'Pretendard', sans-serif;
    font-weight: 500;
    font-size: 14px;
    color: #6b7280;
}

.uploaded-image {
    position: relative;
    width: 100%;
    height: 120px;
    border-radius: 10px;
    overflow: hidden;
}

.uploaded-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.remove-image {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 24px;
    height: 24px;
    background: rgba(0, 0, 0, 0.6);
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
}

.remove-image:hover {
    background: rgba(0, 0, 0, 0.8);
}

.error-message {
    display: flex;
    align-items: center;
    gap: 5px;
    margin-top: 5px;
}

.error-icon {
    width: 22px;
    height: 21px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    color: #ed6060;
}

.error-message span:last-child {
    font-family: 'Pretendard', sans-serif;
    font-weight: 500;
    font-size: 14px;
    color: #ed6060;
    letter-spacing: -0.28px;
}

/* ê³¼ë¯¼ ìŒì‹ ì„­ì·¨ ì—¬ë¶€ */
.sensitive-food-section {
    padding: 0 30px 30px;
}

.sensitive-food-section h2 {
    font-family: 'Pretendard', sans-serif;
    font-weight: 700;
    font-size: 19px;
    color: #212121;
    letter-spacing: -0.5px;
    margin-bottom: 15px;
}

/* High-FODMAP ìŒì‹ ì„­ì·¨ ì—¬ë¶€ */
.High-FODMAP-food-section {
    padding: 0 30px 30px;
}

.High-FODMAP-food-section h2 {
    font-family: 'Pretendard', sans-serif;
    font-weight: 700;
    font-size: 19px;
    color: #212121;
    letter-spacing: -0.5px;
    margin-bottom: 15px;
}

.High-FODMAP-input {
    position: relative;
    margin-bottom: 10px;
}

.High-FODMAP-input input {
    width: 100%;
    height: 45px;
    border: 1px solid #a8a8a8;
    border-radius: 8px;
    padding: 0 40px 0 13px;
    font-family: 'Pretendard', sans-serif;
    font-weight: 500;
    font-size: 14px;
    letter-spacing: -0.28px;
    color: #a5a5a5;
}

.High-FODMAP-list {
    background-color: #21212182;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    z-index: 1000;
}

.High-FODMAP-select-area {
    position: absolute;
    bottom: 0;
    display: flex;
    flex-direction: column;
    gap: 10px;
    width: 100%;
    height: 85vh;
    background: #ffffff;
    padding: 15px;
    padding-bottom: 50px;
    border-radius: 15px 15px 0 0;
}

.High-FODMAP-list-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 10px;
    font-weight: 700;
}

.High-FODMAP-toggle {
    display: flex;
    align-items: center;
    gap: 10px;
}

.High-FODMAP-toggle span {
    font-family: 'Pretendard', sans-serif;
    font-weight: 500;
    font-size: 15px;
    color: #999999;
    letter-spacing: -0.38px;
}

.High-FODMAP-toggle .active {
    background-color: #32A59C;
}

.High-FODMAP-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.High-FODMAP-item-list {
    overflow: scroll;
}

.High-FODMAP-list .High-FODMAP-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 15px 5px;
    margin: 5px 10px;
    border-bottom: 1px solid #e9eaec;
}

.close-High-FODMAP-btn {
    font-family: 'Pretendard', sans-serif;
    background-color: #E6E5E6;
    width: 87px;
    height: 8px;
    border-radius: 5px;
    margin: 5px 0 15px;
    cursor: pointer;
    align-self: center;
}

.High-FODMAP-food-list-footer {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100px;
}

.add-High-FODMAP-btn {
    background-color: #32A59C;
    color: #ffffff;
    font-weight: 500;
    width: 300px;
    height: 48px;
    border-radius: 25px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.toggle-High-FODMAP-switch {
    position: relative;
    width: 31px;
    height: 18px;
    background: #e1e7e5;
    border-radius: 53px;
    cursor: pointer;
}

.toggle-High-FODMAP-slider {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 14px;
    height: 14px;
    background: #ffffff;
    border-radius: 50%;
    transition: transform 0.2s;
}

.toggle-High-FODMAP-switch.active .toggle-High-FODMAP-slider {
    transform: translateX(13px);
}

.sensitive-input {
    position: relative;
    margin-bottom: 10px;
}

.sensitive-input input {
    width: 100%;
    height: 45px;
    border: 1px solid #a8a8a8;
    border-radius: 8px;
    padding: 0 40px 0 13px;
    font-family: 'Pretendard', sans-serif;
    font-weight: 500;
    font-size: 14px;
    letter-spacing: -0.28px;
    color: #a5a5a5;
}

.sensitive-food-list{
    background-color: #21212182;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    z-index: 1000;
}

.sensitive-food-select-area{
    position: absolute;
    bottom: 0;
    display: flex;
    flex-direction: column;
    gap: 10px;
    width: 100%;
    height: 85vh;
    background: #ffffff;
    padding: 15px;
    border-radius: 15px 15px 0 0;
}

.food-list-header{
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding : 0 10px;
    font-weight: 700;
}

.sensitive-toggle {
    display: flex;
    align-items: center;
    gap: 10px;
}

.sensitive-toggle span {
    font-family: 'Pretendard', sans-serif;
    font-weight: 500;
    font-size: 15px;
    color: #999999;
    letter-spacing: -0.38px;
}

.sensitive-toggle .active {
    background-color: #32A59C;
}


.food-info{
    display: flex;
    align-items: center;
    gap: 10px;
}

.food-level{
    font-family: 'Pretendard', sans-serif;
    font-weight: 500;
    font-size: 10px;
    padding: 2px 8px;
    background-color: #E6E5E6;
    border-radius: 15px;
    color: #999999;
    letter-spacing: -0.38px;
}
.food-item-list{overflow: scroll;}
.sensitive-food-list .food-item{
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 15px 5px;
    margin: 5px 10px;
    border-bottom: 1px solid #e9eaec;
}

.close-btn{
    font-family: 'Pretendard', sans-serif;
    background-color: #E6E5E6;
    width: 87px;
    height: 8px;
    border-radius: 5px;
    margin: 5px 0 15px;
    cursor: pointer;
    align-self: center;
}

.sensitive-food-list-footer{
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100px;
}
.add-food-btn{
    background-color: #32A59C;
    color: #ffffff;
    font-weight: 500;
    width: 300px;
    height: 48px;
    border-radius: 25px;
    display: flex;
    align-items: center;
    justify-content: center;
}


.dropdown-arrow {
    position: absolute;
    right: 14px;
    top: 50%;
    transform: translateY(-50%) rotate(270deg);
    width: 13px;
    height: 12px;
    background: #aaaaaa;
    clip-path: polygon(0 0, 100% 0, 50% 100%);
}

/* ì‹í›„ ì»¨ë””ì…˜ ë©”ëª¨ */
.condition-section {
    padding: 0 30px 40px;
}

.condition-section h2 {
    font-family: 'Pretendard', sans-serif;
    font-weight: 700;
    font-size: 19px;
    color: #212121;
    letter-spacing: -0.5px;
    margin-bottom: 15px;
}

.condition-input {
    position: relative;
}

.condition-input input {
    width: 100%;
    height: 45px;
    border: 1px solid #a8a8a8;
    border-radius: 8px;
    padding: 0 40px 0 13px;
    font-family: 'Pretendard', sans-serif;
    font-weight: 500;
    font-size: 14px;
    letter-spacing: -0.28px;
    color: #a5a5a5;
}

.condition-input .dropdown-arrow {
    background: #ececec;
}

/* ê¸°ë¡í•˜ê¸° ë²„íŠ¼ */
.submit-section {
    padding: 0 45px 70px;
}

.submit-btn {
    width: 100%;
    height: 45px;
    border: none;
    border-radius: 100px;
    font-family: 'Pretendard', sans-serif;
    font-weight: 600;
    font-size: 17px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.submit-btn.disabled {
    background: #e9e9e9;
    color: #989898;
}

.submit-btn:not(.disabled) {
    background: #32a59c;
    color: #ffffff;
}

.submit-btn:not(.disabled):hover {
    background: #2a8b82;
}

.food-item input[type="checkbox"] {
    appearance: none;
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    border: 2px solid #e0e0e0;
    border-radius: 50%;
    outline: none;
    cursor: pointer;
    position: relative;
    transition: all 0.2s ease;
}

.food-item input[type="checkbox"]:checked {
    background-color: #00948C;
    border-color: #00948C;
}

.food-item input[type="checkbox"]:checked::after {
    content: 'âœ”';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -100%);
    width: 10px;
    height: 10px;
    color: white;
    border-radius: 50%;
}

.food-item input[type="checkbox"]:hover {
    border-color: #00948C;
}

.High-FODMAP-item input[type="checkbox"] {
    appearance: none;
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    border: 2px solid #e0e0e0;
    border-radius: 50%;
    outline: none;
    cursor: pointer;
    position: relative;
    transition: all 0.2s ease;
}

.High-FODMAP-item input[type="checkbox"]:checked {
    background-color: #00948C;
    border-color: #00948C;
}

.High-FODMAP-item input[type="checkbox"]:checked::after {
    content: 'âœ”';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -100%);
    width: 10px;
    height: 10px;
    color: white;
    border-radius: 50%;
}

.High-FODMAP-item input[type="checkbox"]:hover {
    border-color: #00948C;
}
  
.content{
  height: fit-content;
  overflow: scroll;}
</style>
</head>
<body>
    <div class="wrap">
        <!-- í—¤ë” -->
        <div class="header">
            <button class="home-btn" onclick="goHome()">
                <svg width="17" height="18" viewBox="0 0 17 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M15.5996 17.4004V7.52832L8.09961 0.806641L0.599609 7.5293V17.4004H15.5996Z" stroke="black" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                    <rect x="6.44956" y="12.5997" width="3.3" height="4.8" stroke="black" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <div class="progress-info">
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                </div>
                <span class="progress-text">0 / 4</span>
            </div>
        </div>
		<div class='content'>
		  <!-- ê¸°ë¡í•  ë¼ë‹ˆ ì„ íƒ -->
		  <div class="meal-type-section">
			  <h2>ê¸°ë¡í•  ë¼ë‹ˆ ì„ íƒ <span class="required">* í•„ìˆ˜ ì…ë ¥ ê°’ì…ë‹ˆë‹¤</span></h2>
			  <div class="meal-grid">
				  <div class="meal-option selected" data-meal="breakfast">
					  <div class="meal-emoji">ğŸŒ</div>
					  <span>ì•„ì¹¨</span>
				  </div>
				  <div class="meal-option" data-meal="lunch">
					  <div class="meal-emoji">ğŸŒ¤ï¸</div>
					  <span>ì ì‹¬</span>
				  </div>
				  <div class="meal-option" data-meal="dinner">
					  <div class="meal-emoji">ğŸŒ™</div>
					  <span>ì €ë…</span>
				  </div>
			  </div>
		  </div>

		  <!-- ì‹ì‚¬ ì •ë³´ -->
		  <div class="meal-info-section">
			  <div class="section-header">
				  <h2>ì‹ì‚¬ ì •ë³´</h2>
				  <div class="fasting-toggle">
					  <span>ê³µë³µì…ë‹ˆë‹¤</span>
					  <div class="toggle-switch">
						  <div class="toggle-slider"></div>
					  </div>
				  </div>
			  </div>
			  <div class="meal-input">
				  <input type="text" placeholder="ë“œì‹  ìŒì‹ì„ ê¸°ë¡í•´ì£¼ì„¸ìš”." class="error">
				  
			  </div>
			  <div class="error-message">
				  (ì˜ˆ: ì œìœ¡ë³¶ìŒ 1ì¸ë¶„, ìŒ€ë°¥ 1ê³µê¸°, ì‹œê¸ˆì¹˜ ë¬´ì¹¨, ê°€ì§€ ë³¶ìŒ)
			  </div>
			  <div class='food-upload-area'>
				  <h2>ìŒì‹ ì‚¬ì§„</h2>
				  <div class="photo-upload">
					<div class="upload-area">
					  <input type="file" id="imageUpload" accept="image/*" style="display: none;">
					  <div class="upload-icon">+</div>
					</div>

				  </div>
				<div class="uploaded-image hide">
				   <img id="previewImage" src="" alt="ì—…ë¡œë“œëœ ì´ë¯¸ì§€">
				   <button type="button" class="remove-image">Ã—</button>
			    </div>
			  </div>


		  </div>

		  <!-- ê³¼ë¯¼ ìŒì‹ ì„­ì·¨ ì—¬ë¶€ -->
		  <div class="sensitive-food-section">
			  <h2>ê³¼ë¯¼ ìŒì‹ ì„­ì·¨ ì—¬ë¶€</h2>
			  <div class="sensitive-input">
				  <input type="text" placeholder="ì„­ì·¨í•œ ê³¼ë¯¼ ìŒì‹ì„ ëª¨ë‘ ì„ íƒí•´ ì£¼ì„¸ìš”" class="error" readonly >
				  <div class="dropdown-arrow"></div>
			  </div>
		  </div>
          <div class="sensitive-food-list hide">
            <div class="sensitive-food-select-area">
                <div class="close-btn"></div>
                <div class="food-list-header">
                    <div>ê³¼ë¯¼ ìŒì‹ ì„­ì·¨ ì—¬ë¶€</div>
                    <div class="sensitive-toggle">
                        <div class="toggle-switch">
                            <div class="toggle-slider"></div>
                        </div>
                        <span>ì „ë¶€ ì„­ì·¨ ì•ˆí•¨</span>
                    </div>
                </div>
                <div class="food-item-list">
                    <div class="food-item hide">
                        <div class="food-info">
                            <label for="apple">
                                <span class="food-name">ì‚¬ê³¼</span>
                                <span class="food-level">3ë‹¨ê³„</span>
                            </label>
                        </div>
                        <input type="checkbox" name="food" id="apple">
                    </div>
                </div>
                <div class="sensitive-food-list-footer">
                    <div class="add-food-btn">
                        <span>0</span>ê°œ ì¶”ê°€í•˜ê¸°
                    </div>
                </div>
            </div>
        </div>

        <!-- High-FODMAP ìŒì‹ ì„­ì·¨ ì—¬ë¶€ -->
		  <div class="High-FODMAP-food-section">
            <h2>ê³ í¬ë“œë§µ ìŒì‹ ì„­ì·¨ ì—¬ë¶€</h2>
            <div class="High-FODMAP-input">
                <input type="text" placeholder="ì„­ì·¨í•œ High-FODMAP ìŒì‹ì„ ëª¨ë‘ ì„ íƒí•´ ì£¼ì„¸ìš”" class="error" readonly >
                <div class="dropdown-arrow"></div>
            </div>
        </div>
		  <div class="High-FODMAP-list hide">
            <div class="High-FODMAP-select-area">
                <div class="close-High-FODMAP-btn"></div>
                <div class="High-FODMAP-list-header">
                    <div>ê³ í¬ë“œë§µ ìŒì‹ ì„­ì·¨ ì—¬ë¶€</div>
                    <div class="High-FODMAP-toggle">
                        <div class="toggle-High-FODMAP-switch">
                            <div class="toggle-High-FODMAP-slider"></div>
                        </div>
                        <span>ì „ë¶€ ì„­ì·¨ ì•ˆí•¨</span>
                    </div>
                </div>
                <div class="High-FODMAP-item-list">
                    <div class="High-FODMAP-item hide">
                        <div class="High-FODMAP-info">
                            <label for="apple">
                                <span class="High-FODMAP-name">ì‚¬ê³¼</span>
                            </label>
                        </div>
                        <input type="checkbox" name="food" id="apple">
                    </div>
                </div>
                <div class="High-FODMAP-food-list-footer">
                    <div class="add-High-FODMAP-btn">
                        <span>0</span>ê°œ ì¶”ê°€í•˜ê¸°
                    </div>
                </div>
            </div>
        </div>

		  <!-- ì‹í›„ ì»¨ë””ì…˜ ë©”ëª¨ -->
		  <div class="condition-section">
			  <h2>ì‹í›„ ì»¨ë””ì…˜ ë©”ëª¨</h2>
			  <div class="condition-input">
				  <input type="text" placeholder="ì‹í›„ ì»¨ë””ì…˜ì„ ì…ë ¥í•´ì£¼ì„¸ìš”">
			  </div>
		  </div>

		  <!-- ê¸°ë¡í•˜ê¸° ë²„íŠ¼ -->
		  <div class="submit-section">
			  <button class="submit-btn disabled" onclick="submitMeal()">ê¸°ë¡í•˜ê¸°</button>
		  </div>
        </div>
    </div>
    <script>
        let MEMBER_UID = 'jisoo@biocom.kr'
    </script>
    <script>

        // ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € í˜¸í™˜ì„±ì„ ìœ„í•œ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
function isMobileBrowser() {
    const userAgent = navigator.userAgent || navigator.vendor || window.opera;
    return /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent.toLowerCase());
}

// í•œêµ­ ì‹œê°„ ê¸°ì¤€ Date ê°ì²´ ìƒì„±
function getKoreanDateTime() {
    const now = new Date();
    return new Date(now.getTime() + (9 * 60 * 60 * 1000));
}

// í•œêµ­ ì‹œê°„ ê¸°ì¤€ ë‚ ì§œ ë¬¸ìì—´ ë°˜í™˜ (YYYY-MM-DD)
function getKoreanDate() {
    const now = new Date();
    const koreanTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    return koreanTime.toISOString().split('T')[0];
}

// Safari í˜¸í™˜ ì•ˆì „í•œ ë‚ ì§œ íŒŒì‹± í•¨ìˆ˜
function safeParseDate(dateString) {
    if (!dateString) return null;
    
    try {
        // Safari í˜¸í™˜: '-' â†’ '/', ì‹œê°„ ì œê±°
        const cleanDateStr = (dateString.split('T')[0] || dateString.split(' ')[0] || '').replace(/-/g, '/');
        const parsed = new Date(cleanDateStr);
        
        if (!isNaN(parsed)) {
            // íŒŒì‹±ëœ ë‚ ì§œë¥¼ í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë³€í™˜
            return new Date(parsed.getTime() + (9 * 60 * 60 * 1000));
        }
    } catch (error) {
        console.warn('ë‚ ì§œ íŒŒì‹± ì‹¤íŒ¨:', dateString, error);
    }
    
    return null;
}

// í•œêµ­ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ í˜„ì¬ ì‹œê°„ ì •ë³´ ë°˜í™˜
function getKoreanTimeInfo() {
    const koreanNow = getKoreanDateTime();
    return {
        date: koreanNow.toISOString().split('T')[0],
        time: koreanNow.toISOString().split('T')[1].split('.')[0],
        hour: koreanNow.getUTCHours(),
        minute: koreanNow.getUTCMinutes(),
        dayOfWeek: ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][koreanNow.getUTCDay()]
    };
}

// ì„ íƒëœ ë¼ë‹ˆ íƒ€ì…
let selectedMealType = 'breakfast';

    setTimeout(()=>{
document.getElementById('ch-plugin-entry')?.classList.add('hide')}, 2000)

// API ê´€ë ¨ ì „ì—­ ë³€ìˆ˜
const API_BASE_URL = 'https://biocom.ai.kr/api/v1';
let uploadedFileId = null; // ì—…ë¡œë“œëœ ì´ë¯¸ì§€ì˜ fileId
let checkedFoods = new Set(); // ì²´í¬ëœ ìŒì‹ ëª©ë¡
let checkedFodmapFoods = new Set(); // ì²´í¬ëœ High-FODMAP ìŒì‹ ëª©ë¡
let selectedImageFile = null; // ì„ íƒëœ ì´ë¯¸ì§€ íŒŒì¼

// ì‚¬ìš©ì ì •ë³´ ì„¤ì • (ì‹¤ì œ êµ¬í˜„ ì‹œ ì¸ì¦ ì‹œìŠ¤í…œì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨)
function setUserInfo() {
    // MEMBER_UIDëŠ” ì „ì—­ìœ¼ë¡œ ë‹¤ë¥¸ ê³³ì—ì„œ ì£¼ì…ë¨
    // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì„¸ì…˜, ë¡œì»¬ ìŠ¤í† ë¦¬ì§€, ë˜ëŠ” ì¸ì¦ í† í°ì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì™€ì•¼ í•¨
    // ì˜ˆì‹œ: MEMBER_UID = localStorage.getItem('userEmail') || sessionStorage.getItem('userEmail');
    
    if (typeof MEMBER_UID === 'undefined' || !MEMBER_UID) {
        console.error('ì‚¬ìš©ì ì •ë³´ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        alert('ì‚¬ìš©ì ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
        // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        // window.location.href = '/login';
    }
}

// í™ˆìœ¼ë¡œ ì´ë™
function goHome() {
    window.location.href = 'https://biocom.kr/arang-home';
}

// ì´ë¯¸ì§€ ì—…ë¡œë“œ API í˜¸ì¶œ
async function uploadImage(file) {
    try {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('relatedType', 'DIET');
        
        const response = await fetch(`${API_BASE_URL}/upload/image?email=${MEMBER_UID}&relatedType=DIET`, {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            throw new Error('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
        
        const result = await response.json();
        return result.data.id;
    } catch (error) {
        console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
        throw error;
    }
}

// ì‹ì‚¬ ê¸°ë¡ ì €ì¥ API í˜¸ì¶œ
async function saveMealRecord(mealData) {
    try {
        // í•œêµ­ ì‹œê°„ ê¸°ì¤€ í˜„ì¬ ë‚ ì§œ
        const today = getKoreanDate() + 'T00:00:00.000Z';
        
        const requestData = {
            type: "DIET",
            date: today,
            fileId: uploadedFileId || null,
            data: {
                mealType: mealData.mealType,
                menu: mealData.isFasting ? ['ê³µë³µ'] : (mealData.mealContent ? mealData.mealContent.split(',').map(item => item.trim()) : ['ê³µë³µ']),
                isFasting: mealData.isFasting,
                allergyFoods: mealData.allergyFoods,
                memo: mealData.condition
            }
        };
        
        // API ìš”ì²­ payload ì¶œë ¥
        console.log('=== ì‹ì‚¬ ê¸°ë¡ API ìš”ì²­ ===');
        console.log('í•œêµ­ ì‹œê°„ ê¸°ì¤€ í˜„ì¬ ë‚ ì§œ:', getKoreanDate());
        console.log('ì‹ì‚¬ ê¸°ë¡ API ìš”ì²­ ë°ì´í„°:', requestData);
        console.log('ìš”ì²­ URL:', `${API_BASE_URL}/activity?email=${MEMBER_UID}`);
        console.log('========================');
        
        const response = await fetch(`${API_BASE_URL}/activity?email=${MEMBER_UID}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
  
        const mealMapping = {
            "breakfast":'ì•„ì¹¨', "lunch" :'ì ì‹¬', 'dinner':'ì €ë…', 'snack':'ê°„ì‹','late_night':'ì•¼ì‹'
        }
		console.log(mealMapping[mealData.mealType], response, response.status)
		
        if (!response.ok) {
            if(response.status == 409) {
                alert(`${mealMapping[mealData.mealType]} ê¸°ë¡ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.`)
                return 'dupple';
            }else{
                const errorText = await response.text();
                console.error('API ì‘ë‹µ ì—ëŸ¬:', response.status, errorText);
                throw new Error(`ì‹ì‚¬ ê¸°ë¡ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (${response.status})`);

            }
        }
        
        const result = await response.json();
        console.log('ì‹ì‚¬ ê¸°ë¡ API ì‘ë‹µ:', result);
        return result;
    } catch (error) {
	    console.log(error)
        console.error('ì‹ì‚¬ ê¸°ë¡ ì €ì¥ ì˜¤ë¥˜:', error);
        throw error;
    }
}

// ê³¼ë¯¼ìŒì‹ ì •ë³´ ì¡°íšŒ API í˜¸ì¶œ
async function getFoodList() {
    try {
        const response = await fetch(`${API_BASE_URL}/users/allergy-foods?email=${MEMBER_UID}`);
        
        if (!response.ok) {
            throw new Error('ê³¼ë¯¼ìŒì‹ ì •ë³´ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
        
        const result = await response.json();
        return result.data;
    } catch (error) {
        console.error('ê³¼ë¯¼ìŒì‹ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
        throw error;
    }
}

// ì…ë ¥ í•„ë“œ ê²€ì¦
function validateForm() {
    const mealInput = document.querySelector('.meal-input input');
    const sensitiveInput = document.querySelector('.sensitive-input input');
    const submitBtn = document.querySelector('.submit-btn');
    const isToggleActive = document.querySelector('.toggle-switch').classList.contains('active');
    
    let isValid = true;
    
    // ë¼ë‹ˆ ì„ íƒ í™•ì¸
    if (!selectedMealType) {
        isValid = false;
    }
    
    // ì‹ì‚¬ ì •ë³´ í™•ì¸ (ê³µë³µì´ ì•„ë‹Œ ê²½ìš°ë§Œ)
    if (!isToggleActive && (!mealInput.value || mealInput.value.trim() === '')) {
        isValid = false;
        mealInput.classList.add('error');
    } else {
        mealInput.classList.remove('error');
    }
    
    // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    if (isValid) {
        submitBtn.classList.remove('disabled');
    } else {
        submitBtn.classList.add('disabled');
    }
    
    return isValid;
}

// ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
function updateProgress() {
    const progressFill = document.querySelector('.progress-fill');
    const progressText = document.querySelector('.progress-text');
    
    let completedSteps = 0;
    
    // ë¼ë‹ˆ ì„ íƒë¨
    if (selectedMealType) completedSteps++;
    
    // ì‹ì‚¬ ì •ë³´ ì…ë ¥ë¨ ë˜ëŠ” ê³µë³µ ì„ íƒë¨
    const mealInput = document.querySelector('.meal-input input');
    const isToggleActive = document.querySelector('.toggle-switch').classList.contains('active');
    if (isToggleActive || (mealInput.value && mealInput.value.trim() !== '')) {
        completedSteps++;
    }
    
    // ê³¼ë¯¼ìŒì‹ ì„­ì·¨ ì—¬ë¶€ í™•ì¸
    const sensitiveInput = document.querySelector('.sensitive-input input');
    if (sensitiveInput.value && sensitiveInput.value.trim() !== '') {
        completedSteps++;
    }
    
    // ì´ë¯¸ì§€ ì„ íƒ í™•ì¸ (ì„ íƒì‚¬í•­) - ì§„í–‰ë¥ ì— í¬í•¨í•˜ì§€ ì•ŠìŒ
    
    const percentage = (completedSteps / 3) * 100; // ì´ 3ë‹¨ê³„ë¡œ ë³€ê²½
    progressFill.style.width = `${percentage}%`;
    progressText.textContent = `${completedSteps} / 3`;
}

// ê¸°ë¡í•˜ê¸° ë²„íŠ¼
async function submitMeal() {
    const submitBtn = document.querySelector('.submit-btn');
    
    if (submitBtn.classList.contains('disabled')) {
        alert('í•„ìˆ˜ ì…ë ¥ ê°’ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // ê³µë³µì´ ì•„ë‹Œ ê²½ìš° ì´ë¯¸ì§€ ì²¨ë¶€ í™•ì¸
    const isFasting = document.querySelector('.toggle-switch').classList.contains('active');
    if (!isFasting && !selectedImageFile) {
        alert('ê³µë³µì´ ì•„ë‹Œ ê²½ìš° ì´ë¯¸ì§€ë¥¼ ì²¨ë¶€í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // ë²„íŠ¼ ë¹„í™œì„±í™”
    submitBtn.disabled = true;
    submitBtn.textContent = 'ì €ì¥ ì¤‘...';
    
    try {
        // 1. ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²½ìš° ë¨¼ì € ì—…ë¡œë“œ
        if (selectedImageFile && !isFasting) {
            console.log('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘...');
            uploadedFileId = await uploadImage(selectedImageFile);
            console.log('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„±ê³µ, fileId:', uploadedFileId);
        }
        
        // 2. ê³¼ë¯¼ìŒì‹ ë°ì´í„° êµ¬ì¡°í™”
        const allergyFoods = [];
        const levelGroups = {};
        
        // ì²´í¬ëœ ìŒì‹ë“¤ì„ ë ˆë²¨ë³„ë¡œ ê·¸ë£¹í™”
        checkedFoods.forEach(foodName => {
            const foodItem = document.querySelector(`input[id="${foodName}"]`).closest('.food-item');
            const levelText = foodItem.querySelector('.food-level').textContent;
            const level = levelText.replace('ë‹¨ê³„', '');
            
            if (!levelGroups[level]) {
                levelGroups[level] = [];
            }
            levelGroups[level].push(foodName);
        });
        
        // API í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        Object.keys(levelGroups).forEach(level => {
            allergyFoods.push({
                level: level,
                items: levelGroups[level]
            });
        });
        
        // 3. ì…ë ¥ ì •ë³´ ìˆ˜ì§‘
        const mealInfo = {
            mealType: selectedMealType,
            mealContent: document.querySelector('.meal-input input').value || '',
            sensitiveFoods: document.querySelector('.sensitive-input input').value || '',
            fodmapFoods: document.querySelector('.High-FODMAP-input input').value || '',
            condition: document.querySelector('.condition-input input').value || '',
            isFasting: document.querySelector('.toggle-switch').classList.contains('active'),
            allergyFoods: allergyFoods
        };
        
        // ì½˜ì†”ì— ì¶œë ¥
        console.log('ì‹ë‹¨ ê¸°ë¡ ì •ë³´:', mealInfo);
        
        // 4. ì‹ì‚¬ ê¸°ë¡ ì €ì¥ API í˜¸ì¶œ
        const result = await saveMealRecord(mealInfo);
        console.log('ì‹ì‚¬ ê¸°ë¡ ì €ì¥ ê²°ê³¼:', result);
        if(result == 'dupple') return ;
        
        // ê¸°ë¡ ì™„ë£Œ ì²˜ë¦¬
        // alert('ì‹ë‹¨ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
        
        // í¬ì¸íŠ¸ ì§€ê¸‰ í™”ë©´ìœ¼ë¡œ ì´ë™ (ì‹¤ì œë¡œëŠ” ì¡°ê±´ì— ë”°ë¼)
        if(result.data.points > 0){
            window.location.href = `https://biocom.kr/arang-reward-modal?type=meal&point=${result.data.points}`;
        }else{
            window.location.href = 'https://biocom.kr/arang-reward-modal?type=meal';
        }
        
    } catch (error) {
        console.error('ì‹ì‚¬ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:', error);
        alert('ì‹ì‚¬ ê¸°ë¡ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    } finally {
        // ë²„íŠ¼ ìƒíƒœ ë³µì›
        submitBtn.disabled = false;
        submitBtn.textContent = 'ê¸°ë¡í•˜ê¸°';
    }
}

const observer = new MutationObserver((mutations) => {
    const target = document.getElementById('ch-plugin-entry');
    if (target) {
        target.classList.add('hide');
        console.log('ìˆ¨ê¹€ ì²˜ë¦¬ ì™„ë£Œ');
        observer.disconnect(); // í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ë©´ ê°ì‹œ ì¤‘ë‹¨
    }
});


const load = async () =>{
    // í•œêµ­ ì‹œê°„ ê¸°ì¤€ ì´ˆê¸°í™”
    const timeInfo = getKoreanTimeInfo();
    console.log('=== í˜ì´ì§€ ë¡œë“œ - í•œêµ­ ì‹œê°„ ì •ë³´ ===');
    console.log('ë‚ ì§œ:', timeInfo.date);
    console.log('ì‹œê°„:', timeInfo.time);
    console.log('ìš”ì¼:', timeInfo.dayOfWeek);
    console.log('ëª¨ë°”ì¼ ë¸Œë¼ìš°ì €:', isMobileBrowser());
    console.log('====================================');
    
    // ì‚¬ìš©ì ì •ë³´ ì„¤ì •
    setUserInfo();
    
    // ì²´í¬ëœ ìŒì‹ ëª©ë¡ ì´ˆê¸°í™”
    checkedFoods.clear();
    checkedFodmapFoods.clear();
    
    // ì„ íƒëœ ì´ë¯¸ì§€ íŒŒì¼ ì´ˆê¸°í™”
    selectedImageFile = null;
    uploadedFileId = null;
    
    document.querySelector('div#s202501175ad3b318a8aab')?.classList.add('hide');
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
    
    try {
        // ê³¼ë¯¼ìŒì‹ ì •ë³´ API í˜¸ì¶œ
        const foodListData = await getFoodList();
        
        // level3~5ì˜ ê³¼ë¯¼ìŒì‹ë§Œ í•„í„°ë§ (ê¸°ì¡´ ë¡œì§ê³¼ ë™ì¼)
        const sensitiveFoodList = [];
        foodListData.forEach(levelData => {
            if ([ '4', '5'].includes(levelData.level)) {
                sensitiveFoodList.push(...levelData.items);
            }
        });

        // ê³¼ë¯¼ ìŒì‹ ë¦¬ìŠ¤íŠ¸ ìƒì„±
        const foodListContainer = document.createDocumentFragment();

        // í…œí”Œë¦¿ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const templateItem = document.querySelector('.food-item');
        
        sensitiveFoodList.forEach((food, index) => {
            // í…œí”Œë¦¿ í´ë¡ 
            const foodItem = templateItem.cloneNode(true);
            foodItem.classList.remove('hide');
            
            // ìŒì‹ ì´ë¦„ê³¼ ë‹¨ê³„ ì—…ë°ì´íŠ¸
            const foodName = foodItem.querySelector('.food-name');
            const foodLevel = foodItem.querySelector('.food-level');
            const label = foodItem.querySelector('label');
            const checkbox = foodItem.querySelector('input[type="checkbox"]');
            
            foodName.textContent = food;
            
            // level3~5ì— ë”°ë¼ ë‹¨ê³„ í‘œì‹œ
            const levelData = foodListData.find(level => level.items.includes(food));
            if (levelData) {
                foodLevel.textContent = `${levelData.level}ë‹¨ê³„`;
                
                // ë ˆë²¨ì— ë”°ë¥¸ ë°°ê²½ìƒ‰ ì„¤ì • (report ìŠ¤íƒ€ì¼ ì°¸ê³ )
                const level = levelData.level;
                if (level === '5') {
                    foodLevel.style.backgroundColor = '#fac7c8'; // ê°ˆìƒ‰ìƒ‰
                    foodLevel.style.color = '#421516';
                } else if (level === '4') {
                    foodLevel.style.backgroundColor = '#fac7c8'; // ë¹¨ê°•
                    foodLevel.style.color = '#730003';
                } else if (level === '3') {
                    foodLevel.style.backgroundColor = '#fed4bd'; // ì£¼í™©
                    foodLevel.style.color = '#81340A';
                } else if (level === '2') {
                    foodLevel.style.backgroundColor = '#fdebc0'; // ë…¸ë‘
                    foodLevel.style.color = '#973F2A';
                } else if (level === '1') {
                    foodLevel.style.backgroundColor = '#c4dff4'; // íŒŒíŒŒë‘
                    foodLevel.style.color = '#194569';
                }
            }
            
            // ì²´í¬ë°•ìŠ¤ ID ì„¤ì •
            checkbox.id = `${food}`;
            label.htmlFor = `${food}`;
            
            // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            checkbox.addEventListener('change', handleCheckboxChange);
            
            foodListContainer.appendChild(foodItem);
        });

        document.querySelector('.food-item-list').appendChild(foodListContainer);
        
        // ì´ˆê¸° ì²´í¬ëœ í•­ëª© ê°œìˆ˜ ì—…ë°ì´íŠ¸
        updateCheckedCount();
        
        // High-FODMAP ìŒì‹ ë¦¬ìŠ¤íŠ¸ ìƒì„±
        const fodmapFoodList = ['ë°€ê°€ë£¨', 'ë³´ë¦¬', 'ë§ˆëŠ˜', 'ì–‘íŒŒ', 'ê¹€ì¹˜', 'ê³ ì¶”ì¥', 'ëœì¥', 'ì½©ë¥˜', 'ìš°ìœ ', 'ìš”ê±°íŠ¸', 'ì•„ì´ìŠ¤í¬ë¦¼', 'ì‚¬ê³¼', 'ë°°', 'ê¿€', 'ê³ êµ¬ë§ˆ', 'ì•„ëª¬ë“œ'];
        const fodmapListContainer = document.createDocumentFragment();
        
        // í…œí”Œë¦¿ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const fodmapTemplateItem = document.querySelector('.High-FODMAP-item');
        
        fodmapFoodList.forEach((food, index) => {
            // í…œí”Œë¦¿ í´ë¡ 
            const fodmapItem = fodmapTemplateItem.cloneNode(true);
            fodmapItem.classList.remove('hide');
            
            // ìŒì‹ ì´ë¦„ ì—…ë°ì´íŠ¸
            const fodmapName = fodmapItem.querySelector('.High-FODMAP-name');
            const label = fodmapItem.querySelector('label');
            const checkbox = fodmapItem.querySelector('input[type="checkbox"]');
            
            fodmapName.textContent = food;
            
            // ì²´í¬ë°•ìŠ¤ ID ì„¤ì •
            checkbox.id = `fodmap_${food}`;
            label.htmlFor = `fodmap_${food}`;
            
            // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            checkbox.addEventListener('change', handleFodmapCheckboxChange);
            
            fodmapListContainer.appendChild(fodmapItem);
        });

        document.querySelector('.High-FODMAP-item-list').appendChild(fodmapListContainer);
        
        // ì´ˆê¸° ì²´í¬ëœ High-FODMAP í•­ëª© ê°œìˆ˜ ì—…ë°ì´íŠ¸
        updateFodmapCheckedCount();
        
    } catch (error) {
        console.error('ê³¼ë¯¼ìŒì‹ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('ê³¼ë¯¼ìŒì‹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
    }

    // ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', function() {
            validateForm();
            updateProgress();
            
            // ì…ë ¥ê°’ì´ ìˆì„ ë•Œ í…Œë‘ë¦¬ ìƒ‰ìƒ ë³€ê²½
            if (this.value.trim() !== '') {
                this.style.border = '1px solid #a8a8a8';
                
                // meal-inputì¸ ê²½ìš° ì—ëŸ¬ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                if (this.closest('.meal-input')) {
                    this.classList.remove('error');
                }
                // sensitive-inputì¸ ê²½ìš° ì—ëŸ¬ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                if (this.closest('.sensitive-input')) {
                    this.classList.remove('error');
                }
            } else {
                // meal-inputì¸ ê²½ìš° ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                if (this.closest('.meal-input')) {
                    this.classList.add('error');
                }
                // sensitive-inputì¸ ê²½ìš° ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                if (this.closest('.sensitive-input')) {
                    this.classList.add('error');
                }
            }
        });
    });
    // ì‚¬ì§„ ì—…ë¡œë“œ ì˜ì—­ í´ë¦­
    document.querySelector('.upload-area').addEventListener('click', function() {
        document.getElementById('imageUpload').click();
    });

    // ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
    document.getElementById('imageUpload').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // íŒŒì¼ íƒ€ì… ê²€ì¦
        if (!file.type.startsWith('image/')) {
            alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            return;
        }
        
        // íŒŒì¼ í¬ê¸° ê²€ì¦ (5MB ì œí•œ)
        if (file.size > 5 * 1024 * 1024) {
            alert('íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
            return;
        }
        
        try {
            // ì´ë¯¸ì§€ ì••ì¶• (1MB ì´í•˜ë¡œ)
            const compressedFile = await compressImage(file, 1);
            console.log('ì›ë³¸ íŒŒì¼ í¬ê¸°:', (file.size / 1024 / 1024).toFixed(2), 'MB');
            console.log('ì••ì¶• í›„ íŒŒì¼ í¬ê¸°:', (compressedFile.size / 1024 / 1024).toFixed(2), 'MB');
            
            // ì••ì¶•ëœ íŒŒì¼ì„ ì„ íƒëœ ì´ë¯¸ì§€ë¡œ ì €ì¥ (í•œêµ­ ì‹œê°„ ê¸°ì¤€)
            const koreanNow = getKoreanDateTime();
            selectedImageFile = new File([compressedFile], file.name, {
                type: 'image/jpeg',
                lastModified: koreanNow.getTime()
            });
            
            // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewImage = document.getElementById('previewImage');
                previewImage.src = e.target.result;
                
                // ì—…ë¡œë“œ ì˜ì—­ ìˆ¨ê¸°ê³  ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                document.querySelector('.upload-area').classList.add('hide');
                document.querySelector('.uploaded-image').classList.remove('hide');
            };
            reader.readAsDataURL(compressedFile);
            
            // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (ì´ë¯¸ì§€ê°€ ì„ íƒë˜ì—ˆìœ¼ë¯€ë¡œ)
            updateProgress();
            
        } catch (error) {
            console.error('ì´ë¯¸ì§€ ì••ì¶• ì‹¤íŒ¨:', error);
            alert('ì´ë¯¸ì§€ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            document.getElementById('imageUpload').value = '';
        }
    });

    // ì´ë¯¸ì§€ ì œê±° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    document.querySelector('.remove-image').addEventListener('click', function() {
        // ë¯¸ë¦¬ë³´ê¸° ì œê±°
        document.querySelector('.upload-area').classList.remove('hide');
        document.querySelector('.uploaded-image').classList.add('hide');
        document.getElementById('previewImage').src = '';
        document.getElementById('imageUpload').value = '';
        
        // ì„ íƒëœ ì´ë¯¸ì§€ íŒŒì¼ ì´ˆê¸°í™”
        selectedImageFile = null;
        uploadedFileId = null;
        
        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        updateProgress();
    });

    // ë¼ë‹ˆ ì„ íƒ ì´ë²¤íŠ¸
    document.querySelectorAll('.meal-option').forEach(option => {
        option.addEventListener('click', function() {
            // ì´ì „ ì„ íƒ ì œê±°
            document.querySelectorAll('.meal-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // ìƒˆë¡œìš´ ì„ íƒ ì¶”ê°€
            this.classList.add('selected');
            selectedMealType = this.dataset.meal;
            
            updateProgress();
            validateForm();
        });
    });

    // ê³µë³µ í† ê¸€ ìŠ¤ìœ„ì¹˜
    document.querySelector('.toggle-switch').addEventListener('click', function() {
        this.classList.toggle('active');
        
        const isActive = this.classList.contains('active');
        const mealInput = document.querySelector('.meal-input input');
        const sensitiveToggle = document.querySelector('.sensitive-toggle .toggle-switch');
        const sensitiveInput = document.querySelector('.sensitive-input input');
        const fodmapToggle = document.querySelector('.High-FODMAP-toggle .toggle-High-FODMAP-switch');
        const fodmapInput = document.querySelector('.High-FODMAP-input input');
	    const photo = document.querySelector('.food-upload-area');
        
        if (isActive) {
            mealInput.value = '';
            mealInput.placeholder = 'ê³µë³µ ìƒíƒœì…ë‹ˆë‹¤';
            mealInput.disabled = true;
            mealInput.classList.remove('error');
		    photo.classList.add('hide');
            
            // ê³¼ë¯¼ìŒì‹ ì„­ì·¨ ì—¬ë¶€ ë¹„í™œì„±í™”
            sensitiveToggle.classList.add('active');
            sensitiveInput.value = 'ì „ë¶€ ì„­ì·¨ ì•ˆí•¨';
            sensitiveInput.disabled = true;
            sensitiveInput.classList.remove('error');
            
            // High-FODMAP ìŒì‹ ì„­ì·¨ ì—¬ë¶€ ë¹„í™œì„±í™”
            fodmapToggle.classList.add('active');
            fodmapInput.value = 'ì „ë¶€ ì„­ì·¨ ì•ˆí•¨';
            fodmapInput.disabled = true;
            fodmapInput.classList.remove('error');
            
            // ì²´í¬ëœ ìŒì‹ ëª©ë¡ ì´ˆê¸°í™”
            const checkboxes = document.querySelectorAll('.food-item input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            checkedFoods.clear();
            updateCheckedCount();
            
            // ì²´í¬ëœ High-FODMAP ìŒì‹ ëª©ë¡ ì´ˆê¸°í™”
            const fodmapCheckboxes = document.querySelectorAll('.High-FODMAP-item input[type="checkbox"]');
            fodmapCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            checkedFodmapFoods.clear();
            updateFodmapCheckedCount();
        } else {
            mealInput.placeholder = 'í•„ìˆ˜ ì…ë ¥ ê°’ì…ë‹ˆë‹¤';
            mealInput.disabled = false;
            if (!mealInput.value || mealInput.value.trim() === '') {
                mealInput.classList.add('error');
            }
		    photo.classList.remove('hide');
            
            // ê³¼ë¯¼ìŒì‹ ì„­ì·¨ ì—¬ë¶€ í™œì„±í™”
            sensitiveToggle.classList.remove('active');
            sensitiveInput.value = '';
            sensitiveInput.disabled = false;
            if (!sensitiveInput.value || sensitiveInput.value.trim() === '') {
                sensitiveInput.classList.add('error');
            }
            
            // High-FODMAP ìŒì‹ ì„­ì·¨ ì—¬ë¶€ í™œì„±í™”
            fodmapToggle.classList.remove('active');
            fodmapInput.value = '';
            fodmapInput.disabled = false;
        }
        
        validateForm();
        updateProgress();
    });

    // ì „ë¶€ ì„­ì·¨ ì•ˆí•¨ í† ê¸€ ìŠ¤ìœ„ì¹˜
    document.querySelector('.sensitive-toggle .toggle-switch').addEventListener('click', function() {
        this.classList.toggle('active');
        
        const isActive = this.classList.contains('active');
        const checkboxes = document.querySelectorAll('.food-item input[type="checkbox"]');
        const sensitiveInput = document.querySelector('.sensitive-input input');
        
        // í† ê¸€ì´ í™œì„±í™”ë  ë•Œë§Œ ëª¨ë“  ì²´í¬ë°•ìŠ¤ í•´ì œ ë° ë¹„í™œì„±í™”
        if (isActive) {
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                checkbox.disabled = true;
            });
            // ì²´í¬ëœ ìŒì‹ ëª©ë¡ ì´ˆê¸°í™”
            checkedFoods.clear();
            console.log('ì²´í¬ëœ ìŒì‹ ëª©ë¡:', Array.from(checkedFoods));
            updateCheckedCount();
            
            // ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
            sensitiveInput.value = 'ì „ë¶€ ì„­ì·¨ ì•ˆí•¨';
            sensitiveInput.classList.remove('error');
        } else {
            // í† ê¸€ ë¹„í™œì„±í™” ì‹œ ì²´í¬ë°•ìŠ¤ í™œì„±í™”
            checkboxes.forEach(checkbox => {
                checkbox.disabled = false;
            });
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            sensitiveInput.value = '';
            if (!sensitiveInput.value || sensitiveInput.value.trim() === '') {
                sensitiveInput.classList.add('error');
            }
        }
        
        validateForm();
        updateProgress();
    });

    // High-FODMAP ì „ë¶€ ì„­ì·¨ ì•ˆí•¨ í† ê¸€ ìŠ¤ìœ„ì¹˜
    document.querySelector('.High-FODMAP-toggle .toggle-High-FODMAP-switch').addEventListener('click', function() {
        this.classList.toggle('active');
        
        const isActive = this.classList.contains('active');
        const checkboxes = document.querySelectorAll('.High-FODMAP-item input[type="checkbox"]');
        const fodmapInput = document.querySelector('.High-FODMAP-input input');
        
        // í† ê¸€ì´ í™œì„±í™”ë  ë•Œë§Œ ëª¨ë“  ì²´í¬ë°•ìŠ¤ í•´ì œ ë° ë¹„í™œì„±í™”
        if (isActive) {
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                checkbox.disabled = true;
            });
            // ì²´í¬ëœ High-FODMAP ìŒì‹ ëª©ë¡ ì´ˆê¸°í™”
            checkedFodmapFoods.clear();
            console.log('ì²´í¬ëœ High-FODMAP ìŒì‹ ëª©ë¡:', Array.from(checkedFodmapFoods));
            updateFodmapCheckedCount();
            
            // ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
            fodmapInput.value = 'ì „ë¶€ ì„­ì·¨ ì•ˆí•¨';
            fodmapInput.classList.remove('error');
        } else {
            // í† ê¸€ ë¹„í™œì„±í™” ì‹œ ì²´í¬ë°•ìŠ¤ í™œì„±í™”
            checkboxes.forEach(checkbox => {
                checkbox.disabled = false;
            });
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            fodmapInput.value = '';
        }
        
        validateForm();
        updateProgress();
    });

    // ì¶”ê°€í•˜ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    document.querySelector('.add-food-btn').addEventListener('click', function() {
        const sensitiveInput = document.querySelector('.sensitive-input input');
        console.log(checkedFoods.size);
        if (checkedFoods.size === 0) {
            sensitiveInput.value = 'ì „ë¶€ ì„­ì·¨ ì•ˆí•¨';
        } else {
            sensitiveInput.value = Array.from(checkedFoods).join(', ');
        }
        
        // ì…ë ¥ í•„ë“œ ì—ëŸ¬ ìƒíƒœ ì œê±° ë° í…Œë‘ë¦¬ ìƒ‰ìƒ ë³€ê²½
        sensitiveInput.classList.remove('error');
        sensitiveInput.style.border = '1px solid #a8a8a8';
        
        // ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
        document.querySelector('.sensitive-food-list').classList.add('hide');
    });

    // High-FODMAP ì¶”ê°€í•˜ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    document.querySelector('.add-High-FODMAP-btn').addEventListener('click', function() {
        const fodmapInput = document.querySelector('.High-FODMAP-input input');
        console.log(checkedFodmapFoods.size);
        if (checkedFodmapFoods.size === 0) {
            fodmapInput.value = 'ì „ë¶€ ì„­ì·¨ ì•ˆí•¨';
        } else {
            fodmapInput.value = Array.from(checkedFodmapFoods).join(', ');
        }
        
        // ì…ë ¥ í•„ë“œ ì—ëŸ¬ ìƒíƒœ ì œê±° ë° í…Œë‘ë¦¬ ìƒ‰ìƒ ë³€ê²½
        fodmapInput.classList.remove('error');
        fodmapInput.style.border = '1px solid #a8a8a8';
        
        // ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
        document.querySelector('.High-FODMAP-list').classList.add('hide');
    });

    // ë“œë¡­ë‹¤ìš´ ì…ë ¥ í•„ë“œ í´ë¦­ ì´ë²¤íŠ¸
    document.querySelector('.sensitive-input input').addEventListener('click', function() {
        document.querySelector('.sensitive-food-list').classList.remove('hide');
    });
        
    document.querySelector('.close-btn').addEventListener('click', function() {
        document.querySelector('.sensitive-food-list').classList.add('hide');
    });
    
    document.querySelector('.sensitive-food-list').addEventListener('click', function(e) {
        if(e.target.classList.contains('sensitive-food-list')){
            document.querySelector('.sensitive-food-list').classList.add('hide');
        }
    });

    // High-FODMAP ë“œë¡­ë‹¤ìš´ ì…ë ¥ í•„ë“œ í´ë¦­ ì´ë²¤íŠ¸
    document.querySelector('.High-FODMAP-input input').addEventListener('click', function() {
        document.querySelector('.High-FODMAP-list').classList.remove('hide');
    });
        
    document.querySelector('.close-High-FODMAP-btn').addEventListener('click', function() {
        document.querySelector('.High-FODMAP-list').classList.add('hide');
    });
    
    document.querySelector('.High-FODMAP-list').addEventListener('click', function(e) {
        if(e.target.classList.contains('High-FODMAP-list')){
            document.querySelector('.High-FODMAP-list').classList.add('hide');
        }
    });

    // ì´ˆê¸° ê²€ì¦
    validateForm();
    updateProgress();
}

window.addEventListener('load', load);

// ì²´í¬ëœ í•­ëª© ê°œìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateCheckedCount() {
    const countSpan = document.querySelector('.sensitive-food-list-footer span');
    if (countSpan) {
        countSpan.textContent = checkedFoods.size;
    }
}

// High-FODMAP ì²´í¬ëœ í•­ëª© ê°œìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateFodmapCheckedCount() {
    const countSpan = document.querySelector('.High-FODMAP-food-list-footer span');
    if (countSpan) {
        countSpan.textContent = checkedFodmapFoods.size;
    }
}

// ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³€ê²½ ê°ì§€ í•¨ìˆ˜
function handleCheckboxChange(e) {
    const checkbox = e.target;
    const foodName = checkbox.id;
    
    if (checkbox.checked) {
        checkedFoods.add(foodName);
    } else {
        checkedFoods.delete(foodName);
    }
    
    console.log('ì²´í¬ëœ ìŒì‹ ëª©ë¡:', Array.from(checkedFoods));
    updateCheckedCount();
}

// High-FODMAP ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³€ê²½ ê°ì§€ í•¨ìˆ˜
function handleFodmapCheckboxChange(e) {
    const checkbox = e.target;
    const foodName = checkbox.id.replace('fodmap_', '');
    
    if (checkbox.checked) {
        checkedFodmapFoods.add(foodName);
    } else {
        checkedFodmapFoods.delete(foodName);
    }
    
    console.log('ì²´í¬ëœ High-FODMAP ìŒì‹ ëª©ë¡:', Array.from(checkedFodmapFoods));
    updateFodmapCheckedCount();
}

// ì´ë¯¸ì§€ ì••ì¶• í•¨ìˆ˜
function compressImage(file, maxSizeMB = 1) {
    return new Promise((resolve, reject) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = function() {
            // ì›ë³¸ ì´ë¯¸ì§€ í¬ê¸°
            let { width, height } = img;
            
            // ìµœëŒ€ í¬ê¸° ê³„ì‚° (1MB = 1024 * 1024 bytes)
            const maxSize = maxSizeMB * 1024 * 1024;
            
            // ì´ë¯¸ì§€ í’ˆì§ˆ (0.1 ~ 1.0)
            let quality = 0.8;
            
            // ì´ë¯¸ì§€ í¬ê¸° ì¡°ì • í•¨ìˆ˜
            const resizeImage = () => {
                // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
                canvas.width = width;
                canvas.height = height;
                
                // ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
                ctx.drawImage(img, 0, 0, width, height);
                
                // ì••ì¶•ëœ ì´ë¯¸ì§€ ìƒì„±
                canvas.toBlob((blob) => {
                    if (blob.size <= maxSize) {
                        // ëª©í‘œ í¬ê¸° ì´í•˜ë©´ ì„±ê³µ
                        resolve(blob);
                    } else if (quality > 0.1) {
                        // í’ˆì§ˆì„ ë‚®ì¶°ì„œ ë‹¤ì‹œ ì‹œë„
                        quality -= 0.1;
                        resizeImage();
                    } else if (width > 800 || height > 800) {
                        // í¬ê¸°ë¥¼ ì¤„ì—¬ì„œ ë‹¤ì‹œ ì‹œë„
                        width = Math.floor(width * 0.8);
                        height = Math.floor(height * 0.8);
                        quality = 0.8;
                        resizeImage();
                    } else {
                        // ìµœì†Œ í¬ê¸°ê¹Œì§€ ì¤„ì˜€ëŠ”ë°ë„ í¬ê¸°ê°€ í¬ë©´ ì—ëŸ¬
                        reject(new Error('ì´ë¯¸ì§€ë¥¼ 1MB ì´í•˜ë¡œ ì••ì¶•í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'));
                    }
                }, 'image/jpeg', quality);
            };
            
            resizeImage();
        };
        
        img.onerror = () => {
            reject(new Error('ì´ë¯¸ì§€ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
        };
        
        // ì´ë¯¸ì§€ ë¡œë“œ
        img.src = URL.createObjectURL(file);
    });
}
       </script>
</body>
</html>